name: PR Preview

on:
  pull_request:

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - run: pip install "rendercv[full]"

      - run: rendercv render resume.yaml

      - name: Push PNGs to renders branch
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git fetch origin renders 2>/dev/null && git checkout renders || git checkout --orphan renders
          git rm -rf . --quiet 2>/dev/null || true
          mkdir -p pr-${{ github.event.number }}
          cp rendercv_output/*.png pr-${{ github.event.number }}/
          git add pr-${{ github.event.number }}/
          git commit -m "Render for PR #${{ github.event.number }}"
          git push origin renders

      - name: Comment on PR with preview
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            const base = `https://raw.githubusercontent.com/${owner}/${repo}/renders/pr-${prNumber}`;

            const fs = require('fs');
            const pngs = fs.readdirSync('rendercv_output')
              .filter(f => f.endsWith('.png'))
              .sort();

            const images = pngs
              .map((f, i) => `**Page ${i + 1}**\n![resume page ${i + 1}](${base}/${f})`)
              .join('\n\n');

            const body = `ğŸ“„ **Resume preview**\n\n${images}`;

            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber });
            for (const comment of comments.data) {
              if (comment.user.login === 'github-actions[bot]' && comment.body.startsWith('ğŸ“„ **Resume preview**')) {
                await github.rest.issues.deleteComment({ owner, repo, comment_id: comment.id });
              }
            }

            await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });